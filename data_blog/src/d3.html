<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>D3 Test</title>
    <script></script>

</head>
<body>
<div> <h1>Hello World</h1></div>
<div id="chart"></div>
<script type="text/javascript" src="//d3js.org/d3.v4.min.js"></script>
<script type="text/javascript">

    /*d3.json('data/graph.json', function ( response ) {

        console.log(response);

        //map links
        const links = response.links;
        const nodes = response.nodes;

        var data = [150, 200, 30, 70];

            /*Object.keys(links).map(function(item){
            return item.id;
        });*/

        /*var svg = d3.select('#chart')
            .append("svg")
            .attr("width", 300)
            .attr("height", 200);

        svg.selectAll(".bar")
            .data(data)
            .enter()
            .append("rect")
            .attr({
                class: "bar",
                width: function (d) {
                    return d;
                },
                height: "40",
                y: function (d, i) {
                    return i * 50 + 10;
                },
                x: "10"
            });
    });*/

</script>
<script>


    var margin = {top: 120, right: 20, bottom: 20, left: 350};

    var width = 600 - margin.right - margin.left,
        height = 600 - margin.top - margin.bottom;

    d3.json('data/graph.json', function ( response ) {

        console.log(response);

        //map links
        //const links = response.links;
        //const nodes = response.nodes;

        //console.log(response.nodes);

        var links = Object.values(response["links"]).map(function (item) {
            var newItem = {};
            newItem.age = parseInt(item.age);
            newItem.endNode = parseInt(item.endNode);
            newItem.startNode = parseInt(item.startNode);
            newItem.pathId = parseInt(item.pathId);
            newItem.id = parseInt(item.id);
            newItem.timeDiff = parseInt(item.timeDiff);
            newItem.userId = parseInt(item.userId);
            return newItem;
        });

        var nodes = Object.values(response["nodes"]).map(function (item) {
            var newItem = {};
            //console.log(item.id);
            newItem.id = parseInt(item.id);
            newItem.label = item.label;
            newItem.traffic = item.traffic;
            return newItem;
        });

        const simulation = forceSimulation(nodes, links).on("tick", ticked);


        console.log(Object.values(nodes));


        console.log(Object.keys(nodes).length);
        console.log(Object.keys(links).length);
        console.log(Object.keys(nodes).length);


        const svg = d3.select('#chart')
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        const link = svg.append("g")
            .attr("stroke", "#999")
            .attr("stroke-opacity", 0.6)
            .selectAll("line")
            .data(links)
            .enter().append("line")
            .attr("stroke-width", 0.6);

        const node = svg.append("g")
            .attr("stroke", "#fff")
            .attr("stroke-width", 1.5)
            .selectAll("circle")
            .data(nodes)
            .enter().append("circle")
            .attr("r", 5)
            .attr("fill", "red")
            .call(drag(simulation));

        node.append("title")
            .text(d => d.label);

        link.append("title")
            .text(d => d.userId)


        function forceSimulation(nodes, links) {
            return d3.forceSimulation()
                .force("link", d3.forceLink(links).id(d => d.id))
                .force("charge", d3.forceManyBody())
                .force("center", d3.forceCenter());
        };

        drag = simulation => {

            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        }


        function ticked() {
            link
                .attr("x1", d => d.startNode.x)
                .attr("y1", d => d.startNode.y)
                .attr("x2", d => d.endNode.x)
                .attr("y2", d => d.endNode.y);

            node
                .attr("cx", d => d.x)
                .attr("cy", d => d.y);
        }

        /*function forceSimulation(nodes, links){
            return d3.forceSimulation(nodes)
                .force("link", d3.forceLink(links).id(d => d.id))
                .force("charge", d3.forceManyBody())
                .force("center", d3.forceCenter());
        }

        colorScale = d3.scale.threshold()
            .domain([0.85, 1])
            .range(["#EC9374", "#FDDCC9", "#E0ECF3", "#90C4DD"]);


        var drag = simulation => {

            function dragstarted(d) {
                if (!d3.event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }i1ro0tf

            function dragged(d) {
                d.fx = d3.event.x;
                d.fy = d3.event.y;
            }

            function dragended(d) {
                if (!d3.event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            return d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended);
        };

*/
    });

            /* var data = response.map(function( item ) {
             var newItem = {};
             newItem.country = item.x;
             newItem.product = item.y;
             newItem.value = item.value;
             return newItem;
         })*/

        /*var x_elements = d3.set(data.map(function( item ) { return item.product; } )).values(),
            y_elements = d3.set(data.map(function( item ) { return item.country; } )).values();

        var xScale = d3.scale.ordinal()
            .domain(x_elements)
            .rangeBands([0, x_elements.length * itemSize]);
        var xAxis = d3.svg.axis()
            .scale(xScale)
            .tickFormat(function (d) {
                return d;
            })
            .orient("top");
        var yScale = d3.scale.ordinal()
            .domain(y_elements)
            .rangeBands([0, y_elements.length * itemSize]);
        var yAxis = d3.svg.axis()
            .scale(yScale)
            .tickFormat(function (d) {
                return d;
            })
            .orient("left");
        /*var colorScale = d3.scale.threshold()
            .domain([0.85, 1])
            .range(["#EC9374", "#FDDCC9", "#E0ECF3", "#90C4DD"]);*/
        // .range(["#2980B9", "#E67E22", "#27AE60", "#27AE60"]);
        /*var svg = d3.select('.heatmap')
            .append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
        var cells = svg.selectAll('rect')
            .data(data)
            .enter().append('g').append('rect')
            .attr('class', 'cell')
            .attr('width', cellSize)
            .attr('height', cellSize)
            .attr('y', function(d) { return yScale(d.country); })
            .attr('x', function(d) { return xScale(d.product); })
            .attr('fill', function(d) { return colorScale(d.value); });
        svg.append("g")
            .attr("class", "y axis")
            .call(yAxis)
            .selectAll('text')
            .attr('font-weight', 'normal');
        svg.append("g")
            .attr("class", "x axis")
            .call(xAxis)
            .selectAll('text')
            .attr('font-weight', 'normal')
            .style("text-anchor", "start")
            .attr("dx", ".8em")
            .attr("dy", ".5em")
            .attr("transform", function (d) {
                return "rotate(-65)";
            });
    });*/
</script>
</body>
</html>